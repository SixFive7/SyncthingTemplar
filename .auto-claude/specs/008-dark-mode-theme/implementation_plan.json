{
  "feature": "Dark Mode Theme Persistence and System Sync",
  "workflow_type": "feature",
  "workflow_rationale": "Adding persistence and reactive system synchronization to existing dark mode theme functionality. This is a feature workflow as it extends current capabilities with new user-visible enhancements (LocalStorage persistence, auto/manual mode selection, Windows theme detection).",
  "phases": [
    {
      "id": "phase-1-dependencies",
      "name": "Add Dependencies",
      "type": "setup",
      "description": "Install Blazored.LocalStorage package and register service",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Add Blazored.LocalStorage package reference",
          "service": "syncthing-templar",
          "files_to_modify": ["src/SyncthingTemplar/SyncthingTemplar.csproj"],
          "files_to_create": [],
          "patterns_from": ["src/SyncthingTemplar/SyncthingTemplar.csproj"],
          "verification": {
            "type": "command",
            "command": "dotnet list src/SyncthingTemplar/SyncthingTemplar.csproj package | grep Blazored.LocalStorage",
            "expected": "Blazored.LocalStorage"
          },
          "status": "pending",
          "notes": "Add PackageReference for Blazored.LocalStorage to enable browser LocalStorage access"
        },
        {
          "id": "subtask-1-2",
          "description": "Register LocalStorage service in dependency injection",
          "service": "syncthing-templar",
          "files_to_modify": ["src/SyncthingTemplar/Program.cs"],
          "files_to_create": [],
          "patterns_from": ["src/SyncthingTemplar/Program.cs"],
          "verification": {
            "type": "command",
            "command": "grep -q 'AddBlazoredLocalStorage' src/SyncthingTemplar/Program.cs && echo 'REGISTERED' || echo 'NOT_FOUND'",
            "expected": "REGISTERED"
          },
          "status": "pending",
          "notes": "Add builder.Services.AddBlazoredLocalStorage() before app build to make ILocalStorageService available for injection"
        }
      ]
    },
    {
      "id": "phase-2-persistence",
      "name": "LocalStorage Persistence",
      "type": "implementation",
      "description": "Add theme preference persistence using LocalStorage",
      "depends_on": ["phase-1-dependencies"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Inject ILocalStorageService and load saved theme on startup",
          "service": "syncthing-templar",
          "files_to_modify": ["src/SyncthingTemplar/Components/Layout/MainLayout.razor"],
          "files_to_create": [],
          "patterns_from": ["src/SyncthingTemplar/Components/Layout/MainLayout.razor"],
          "verification": {
            "type": "browser",
            "url": "https://localhost:5134/",
            "checks": [
              "Toggle theme to dark",
              "Refresh page",
              "Dark theme persists after reload"
            ]
          },
          "status": "pending",
          "notes": "Add [Inject] ILocalStorageService property. In OnAfterRenderAsync(firstRender), load 'theme_preference' and 'theme_mode' from LocalStorage. Apply manual theme if mode='manual', otherwise use system preference."
        },
        {
          "id": "subtask-2-2",
          "description": "Save theme preference to LocalStorage on toggle",
          "service": "syncthing-templar",
          "files_to_modify": ["src/SyncthingTemplar/Components/Layout/MainLayout.razor"],
          "files_to_create": [],
          "patterns_from": ["src/SyncthingTemplar/Components/Layout/MainLayout.razor"],
          "verification": {
            "type": "browser",
            "url": "https://localhost:5134/",
            "checks": [
              "Open browser DevTools > Application > LocalStorage",
              "Toggle theme",
              "Verify 'theme_preference' key updated to 'dark' or 'light'",
              "Verify 'theme_mode' key set to 'manual'"
            ]
          },
          "status": "pending",
          "notes": "Update ToggleTheme() method to save theme_preference ('light'/'dark') and set theme_mode to 'manual' when user manually toggles"
        }
      ]
    },
    {
      "id": "phase-3-system-detection",
      "name": "Reactive System Theme Detection",
      "type": "implementation",
      "description": "Add JavaScript interop for Windows system theme change detection",
      "depends_on": ["phase-2-persistence"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create JavaScript module for system theme listener",
          "service": "syncthing-templar",
          "files_to_modify": [],
          "files_to_create": ["src/SyncthingTemplar/wwwroot/js/theme-detector.js"],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "test -f src/SyncthingTemplar/wwwroot/js/theme-detector.js && echo 'EXISTS' || echo 'NOT_FOUND'",
            "expected": "EXISTS"
          },
          "status": "pending",
          "notes": "Create ES6 module with startSystemThemeListener(dotNetHelper) function that uses window.matchMedia('(prefers-color-scheme: dark)') and returns cleanup object with dispose() method"
        },
        {
          "id": "subtask-3-2",
          "description": "Add script reference to App.razor",
          "service": "syncthing-templar",
          "files_to_modify": ["src/SyncthingTemplar/Components/App.razor"],
          "files_to_create": [],
          "patterns_from": ["src/SyncthingTemplar/Components/App.razor"],
          "verification": {
            "type": "command",
            "command": "grep -q 'theme-detector.js' src/SyncthingTemplar/Components/App.razor && echo 'FOUND' || echo 'NOT_FOUND'",
            "expected": "FOUND"
          },
          "status": "pending",
          "notes": "Add <script> tag or ensure wwwroot/js directory is accessible for ES6 module import. May not need explicit reference if using JS interop import."
        },
        {
          "id": "subtask-3-3",
          "description": "Add JS interop and JSInvokable callback in MainLayout",
          "service": "syncthing-templar",
          "files_to_modify": ["src/SyncthingTemplar/Components/Layout/MainLayout.razor"],
          "files_to_create": [],
          "patterns_from": ["src/SyncthingTemplar/Components/Layout/MainLayout.razor"],
          "verification": {
            "type": "browser",
            "url": "https://localhost:5134/settings",
            "checks": [
              "Enable 'Follow System Theme' in Settings",
              "Change Windows theme (Settings > Personalization > Colors)",
              "App theme updates immediately without reload"
            ]
          },
          "status": "pending",
          "notes": "In OnAfterRenderAsync, import JS module and call startSystemThemeListener with DotNetObjectReference. Add [JSInvokable] OnSystemThemeChanged(bool isDark) method that only applies theme if mode='auto'"
        }
      ]
    },
    {
      "id": "phase-4-settings-ui",
      "name": "Settings UI for Auto/Manual Mode",
      "type": "implementation",
      "description": "Add toggle in Settings page for auto vs manual theme mode",
      "depends_on": ["phase-3-system-detection"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Add IsAutoMode cascading parameter to Settings page",
          "service": "syncthing-templar",
          "files_to_modify": [
            "src/SyncthingTemplar/Components/Layout/MainLayout.razor",
            "src/SyncthingTemplar/Components/Pages/Settings/Index.razor"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/SyncthingTemplar/Components/Layout/MainLayout.razor",
            "src/SyncthingTemplar/Components/Pages/Settings/Index.razor"
          ],
          "verification": {
            "type": "browser",
            "url": "https://localhost:5134/settings",
            "checks": [
              "'Follow System Theme' toggle renders",
              "Toggle functional and persists across refreshes"
            ]
          },
          "status": "pending",
          "notes": "Add _isAutoMode state and CascadingValue in MainLayout. Add CascadingParameter and MudSwitch in Settings/Index.razor following existing Dark Mode toggle pattern"
        },
        {
          "id": "subtask-4-2",
          "description": "Wire auto mode toggle to update theme_mode in LocalStorage",
          "service": "syncthing-templar",
          "files_to_modify": [
            "src/SyncthingTemplar/Components/Layout/MainLayout.razor",
            "src/SyncthingTemplar/Components/Pages/Settings/Index.razor"
          ],
          "files_to_create": [],
          "patterns_from": ["src/SyncthingTemplar/Components/Pages/Settings/Index.razor"],
          "verification": {
            "type": "browser",
            "url": "https://localhost:5134/settings",
            "checks": [
              "Toggle 'Follow System Theme' on/off",
              "Check DevTools > Application > LocalStorage",
              "Verify 'theme_mode' switches between 'auto' and 'manual'"
            ]
          },
          "status": "pending",
          "notes": "Add ToggleAutoMode() method in MainLayout that saves theme_mode to LocalStorage and applies system preference when switching to auto"
        }
      ]
    },
    {
      "id": "phase-5-cleanup",
      "name": "Resource Cleanup",
      "type": "implementation",
      "description": "Implement IAsyncDisposable for proper JS resource cleanup",
      "depends_on": ["phase-4-settings-ui"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Implement IAsyncDisposable and dispose JS resources",
          "service": "syncthing-templar",
          "files_to_modify": ["src/SyncthingTemplar/Components/Layout/MainLayout.razor"],
          "files_to_create": [],
          "patterns_from": ["src/SyncthingTemplar/Components/Layout/MainLayout.razor"],
          "verification": {
            "type": "browser",
            "url": "https://localhost:5134/",
            "checks": [
              "Navigate between pages multiple times",
              "Open DevTools > Console",
              "No memory leak warnings",
              "No JavaScript errors about disposed objects"
            ]
          },
          "status": "pending",
          "notes": "Add @implements IAsyncDisposable. In DisposeAsync(), call _themeListener.InvokeVoidAsync('dispose'), dispose _dotNetRef, and dispose _themeDetectorModule"
        }
      ]
    },
    {
      "id": "phase-6-verification",
      "name": "End-to-End Verification",
      "type": "integration",
      "description": "Verify all theme persistence and system sync scenarios work correctly",
      "depends_on": ["phase-5-cleanup"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Verify complete theme persistence flow",
          "service": "syncthing-templar",
          "all_services": false,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "1. First-time user: Open app with no saved preference - verify uses system theme",
              "2. Manual mode: Toggle theme, refresh page - verify theme persists",
              "3. Auto mode: Enable 'Follow System Theme', change Windows theme - verify app updates immediately",
              "4. Manual override: Disable 'Follow System Theme', change Windows theme - verify app ignores system change",
              "5. No theme flash: Refresh page multiple times - verify theme applies instantly without white/black flash",
              "6. LocalStorage: Check DevTools Application tab - verify both keys present with correct values"
            ]
          },
          "status": "pending",
          "notes": "Full end-to-end testing of all theme scenarios specified in spec.md QA section"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 6,
    "total_subtasks": 11,
    "services_involved": ["syncthing-templar"],
    "parallelism": {
      "max_parallel_phases": 1,
      "parallel_groups": [],
      "recommended_workers": 1,
      "speedup_estimate": "1x (sequential)",
      "reasoning": "Each phase depends on the previous phase completing. Phase 2 needs LocalStorage service from Phase 1, Phase 3 needs persistence logic from Phase 2, Phase 4 needs system detection from Phase 3, and Phase 5 adds cleanup to Phase 4's implementation."
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 008 --parallel 1"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": ["unit", "integration"],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "Theme preference persists across page reloads",
      "Auto mode follows Windows system theme changes in real-time",
      "Manual mode ignores system theme changes",
      "No JavaScript errors in browser console",
      "No memory leaks from event listeners",
      "LocalStorage keys present with correct values"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests",
        "command": "dotnet test tests/SyncthingTemplar.Tests/",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Test - JS Interop",
        "command": "dotnet test tests/SyncthingTemplar.Tests/ --filter Category=Integration",
        "expected_outcome": "System theme change events trigger C# callback",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Browser Verification",
        "command": "manual",
        "expected_outcome": "Theme toggles work, LocalStorage keys present, no console errors",
        "type": "browser",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk cross-cutting UI change requires unit tests for theme logic and integration tests for JS interop. Browser verification needed to confirm LocalStorage persistence and system theme detection work correctly."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": ["dotnet test tests/SyncthingTemplar.Tests/"],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": ["dotnet test tests/SyncthingTemplar.Tests/ --filter Category=Integration"],
      "services_to_test": ["syncthing-templar"]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "https://localhost:5134/",
          "checks": [
            "AppBar toggle button changes icon (sun/moon)",
            "Theme applies correctly",
            "No JavaScript errors in console"
          ]
        },
        {
          "url": "https://localhost:5134/settings",
          "checks": [
            "Dark Mode toggle functional",
            "Follow System Theme toggle functional",
            "Both switches persist across refresh"
          ]
        }
      ]
    },
    "database_verification": {
      "required": false,
      "checks": []
    },
    "manual_qa_checklist": [
      "Toggle theme, close browser, reopen - theme persists",
      "Enable auto mode, change Windows theme - app updates immediately",
      "Disable auto mode, change Windows theme - app ignores change",
      "Check DevTools > Application > LocalStorage for theme_preference and theme_mode keys",
      "Navigate between pages - no memory leaks in DevTools Memory profiler",
      "Refresh page multiple times - no theme flash (white/black flicker)"
    ]
  },
  "qa_signoff": null
}
